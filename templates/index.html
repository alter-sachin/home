<html>
  <head>
    <title>File Upload</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.1/min/dropzone.min.css">
  </head>
  <body>
    <h1>File Upload</h1>
    <form action="{{ url_for('upload_files') }}" class="dropzone">
    </form>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.25/webcam.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.1/min/dropzone.min.js"></script>
     <div id="camera" style="height:auto;width:auto; text-align:left;"></div>
      <!--FOR THE SNAPSHOT-->
      <form method="POST" enctype="multipart/form-data" id="myForm">
        <input type="button" value="Take a Snap" id="btPic" onclick="takeSnapShot()" name="userID" name="name"/>
        <p id="snapShot"></p>
    </form>
   
   
  </body>
  <script>
    // CAMERA SETTINGS.
    Webcam.set({
        width: 220,
        height: 190,
        image_format: 'jpeg',
        jpeg_quality: 100
    });
    Webcam.attach('#camera');

    // SHOW THE SNAPSHOT.
    takeSnapShot = function () {
        Webcam.snap(function (data_uri) {
            document.getElementById('snapShot').innerHTML = 
                '<img src="' + data_uri + '" width="220px" height="190px" />';
                
                upload(data_uri);
        });
    }



    function upload(data_uri) {
    var url = "camera";                
    var image = data_uri;
    var blob = makeblob(image)
    //var base64ImageContent = image.replace(/^data:image\/(png|jpeg|jpg);base64,/, '');
    //var blob = base64ToBlob(base64ImageContent, 'image/jpg');                
    var formData = new FormData();
    formData.append('source', blob);
    // for (var key of formData.entries()) {
    //    console.log(key[0] + ', ' + key[1]);
    //}
    console.log(blob);
    var xhr = new XMLHttpRequest();
      xhr.open( 'POST', 'camera', true )
      xhr.onload = xhr.onerror = function() {
        console.log( xhr.responseText )
      };
      xhr.send( formData )
    //$.ajax({
       // url: url, 
       // type: "POST", 
      //  contentType: 'application/octet-stream',
      //  data: formData})
     //       .done(function(e){
     //           alert('done!');
     //       });
    //console.log(formData.get('file'));
    //console.log(formData.get('userID'));
}
makeblob = function (dataURL) {
            var BASE64_MARKER = ';base64,';
            if (dataURL.indexOf(BASE64_MARKER) == -1) {
                var parts = dataURL.split(',');
                var contentType = parts[0].split(':')[1];
                var raw = decodeURIComponent(parts[1]);
                return new Blob([raw], { type: contentType });
            }
            var parts = dataURL.split(BASE64_MARKER);
            var contentType = parts[0].split(':')[1];
            var raw = window.atob(parts[1]);
            var rawLength = raw.length;

            var uInt8Array = new Uint8Array(rawLength);

            for (var i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], { type: contentType });
        }
function base64ToBlob(base64Data, contentType) {
    contentType = contentType || '';
    var sliceSize = 1024;
    var byteCharacters = atob(decodeURIComponent(base64Data));
    var bytesLength = byteCharacters.length;
    var slicesCount = Math.ceil(bytesLength / sliceSize);
    var byteArrays = new Array(slicesCount);

    for (var sliceIndex = 0; sliceIndex < slicesCount; ++sliceIndex) {
        var begin = sliceIndex * sliceSize;
        var end = Math.min(begin + sliceSize, bytesLength);

        var bytes = new Array(end - begin);
        for (var offset = begin, i = 0; offset < end; ++i, ++offset) {
            bytes[i] = byteCharacters[offset].charCodeAt(0);
        }
        byteArrays[sliceIndex] = new Uint8Array(bytes);
    }
    return new Blob(byteArrays, { type: contentType });
}

</script>
</html>